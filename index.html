<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pattern System</title>
<style>
body{font-family:Arial}
table{border-collapse:collapse;font-size:12px}
td,th{border:1px solid #999;padding:4px;text-align:center}
.blank{background:#eee;cursor:pointer}
.circle{border:3px solid red;border-radius:50%}
#checks div{background:#e8ffe8;margin:5px;padding:6px;cursor:pointer}
#popup{position:fixed;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,.6);display:none}
#box{background:#fff;margin:40px auto;padding:10px;width:90%;max-height:80%;overflow:auto}
</style>
</head>
<body>

<h3>Pattern System</h3>
<table id="tbl"></table>

<h4>✔ Check Lines</h4>
<div id="checks"></div>

<div id="popup">
  <div id="box">
    <button onclick="closePop()">Close</button>
    <div id="popData"></div>
  </div>
</div>

<script>
// ===== FAMILY DATA =====
const families={
"12":["12","17","21","26","62","67","71","76"],
"13":["13","18","31","36","63","68","81","86"],
"14":["14","19","41","46","64","69","91","96"],
"15":["01","06","10","15","51","56","60","65"],
"23":["23","28","32","37","73","78","82","87"],
"24":["24","29","42","47","74","79","92","97"],
"25":["02","07","20","25","52","57","70","75"],
"34":["34","39","43","48","84","89","93","98"],
"35":["03","08","30","35","53","58","80","85"],
"45":["04","09","40","45","54","59","90","95"],
"HR":["05","16","27","38","49","50","61","72","83","94"],
"FR":["00","11","22","33","44","55","66","77","88","99"]
};

function norm(v){
 if(v===""||v=="**") return "**";
 v=String(v); return v.length==1?"0"+v:v;
}
function getFamily(v){
 for(let k in families) if(families[k].includes(v)) return k;
 return "NA";
}

// ===== SAMPLE DATA =====
let data=[
["51","91","41","57","19","95"],
["05","90","74","06","19","63"],
["90","34","82","09","28","19"],
["72","34","21","32","21","42"],
["58","84","00","67","06","98"],
["03","82","29","90","14","66"],
["02","40","92","85","00","88"],
["39","94","33","58","11","63"],
["91","69","60","71","85","20"],
["95","28","11","29","28","18"],
["47","83","45","80","33","18"],
["96","25","78","59","30","94"],
["","","","","",""] // blank row
];
data=data.map(r=>r.map(norm));

// ===== RENDER =====
function draw(){
 let t="<tr><th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th></tr>";
 data.forEach((r,ri)=>{
   t+="<tr>";
   r.forEach((c,ci)=>{
     if(c=="**") t+=`<td class='blank' onclick="makePattern(${ri},${ci})">**</td>`;
     else t+=`<td id="c-${ri}-${ci}">${c}</td>`;
   });
   t+="</tr>";
 });
 document.getElementById("tbl").innerHTML=t;
}
draw();

// ===== PATTERN LOGIC =====
let lastMatches=[];

function makePattern(r,c){
 clearMarks();
 let fams=[];
 let rows=[];
 for(let i=r-1;i>=0 && fams.length<4;i--){
   if(data[i][c]!="**"){
     fams.unshift(getFamily(data[i][c]));
     rows.unshift(i);
   }
 }
 if(fams.length<3){alert("Kam data");return;}
 searchPattern(fams,c);
}

function searchPattern(fams,col){
 lastMatches=[];
 for(let j=0;j<6;j++){
   for(let i=0;i<data.length-4;i++){
     let ok=true;
     for(let k=0;k<fams.length;k++){
       if(getFamily(data[i+k][j])!=fams[k]) ok=false;
     }
     if(ok){
       lastMatches.push({r:i,c:j,len:fams.length});
       for(let k=0;k<fams.length;k++){
         let td=document.getElementById(`c-${i+k}-${j}`);
         if(td) td.classList.add("circle");
       }
     }
   }
 }
 showChecks(fams);
}

function clearMarks(){
 document.querySelectorAll(".circle").forEach(e=>e.classList.remove("circle"));
}

// ===== CHECK LINES =====
function showChecks(fams){
 let d=document.getElementById("checks");
 d.innerHTML="";
 let div=document.createElement("div");
 div.innerHTML="Picked families: "+fams.join(" → ");
 d.appendChild(div);

 let div2=document.createElement("div");
 div2.innerHTML=`Pattern found at ${lastMatches.length} places (click)`;
 div2.onclick=()=>showPopup();
 d.appendChild(div2);
}

// ===== POPUP =====
function getNextValidRow(startRow,col){
 for(let i=startRow+1;i<data.length;i++){
   if(data[i][col]!="**") return data[i];
 }
 return null;
}

function showPopup(){
 let html="";
 lastMatches.forEach((m,idx)=>{
   html+="<h4>Match "+(idx+1)+"</h4><table>";
   for(let k=0;k<m.len;k++){
     html+="<tr>";
     data[m.r+k].forEach(v=>html+="<td>"+v+"</td>");
     html+="</tr>";
   }
   let extra=getNextValidRow(m.r+m.len-1,m.c);
   if(extra){
     html+="<tr>";
     extra.forEach(v=>html+="<td>"+v+"</td>");
     html+="</tr>";
   }
   html+="</table>";
 });
 document.getElementById("popData").innerHTML=html;
 document.getElementById("popup").style.display="block";
}
function closePop(){document.getElementById("popup").style.display="none";}
</script>
</body>
</html>
